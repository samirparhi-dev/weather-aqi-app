
name: Security Suite for Containers (K8s & Containerization)

on:
  push:
    branches:
      - main
# on:
#   workflow_dispatch:

jobs:
  Building :
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '14'

    - name: Install dependencies
      run: npm install

    - name: Build React app
      run: npm run build


    - name: Build Docker image
      run: |
        echo $pwd
        ls
        docker build -t weather-aqi-app:latest .
        docker save weather-aqi-app:latest -o weather-aqi-app-image.tar

    - name: Save Docker image
      uses: actions/upload-artifact@v2
      with:
        name: weather-aqi-app-image
        path: |
          ./weather-aqi-app-image.tar

  TrivyImageScan:
    name: Scanning your Container
    runs-on: ubuntu-22.04
    needs: build

    steps:
      - name: Get current timestamp
        id: timestamp
        run: echo "TIMESTAMP=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV

      - name: Download Docker image
        uses: actions/download-artifact@v2
        with:
          name: weather-aqi-app-image

      - name: Run Trivy scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: weather-aqi-app:latest

      - name: Load Docker image
        run: |
          docker load -i weather-aqi-app-image.tar

      - name: Run Trivy scan
        run: |
          docker pull aquasec/trivy:latest
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock -v ${{ github.workspace }}:/workspace aquasec/trivy:latest image --format json --output /workspace/trivy-report-${{ env.TIMESTAMP }}.json weather-aqi-app:latest
      
      - name: Upload Trivy scan report
        uses: actions/upload-artifact@v2
        with:
          name: trivy-report
          path: trivy-report-*.json

      - name: Log in to Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.CONTAINER_SEC }}
      
      - name: Push Container image to GitHub Container Registry
        run: |
          docker tag weather-aqi-app:latest ghcr.io/${{ github.repository_owner }}/weather-aqi-app:latest
          docker push ghcr.io/${{ github.repository_owner }}/weather-aqi-app:latest